FROM docker.io/ubuntu:22.04
#@sha256:09506232a8004baa32c47d68f1e5c307d648fdd59f5e7eaa42aaf87914100db3

RUN groupadd -g 1000 model && \
    useradd -m -u 1000 -g 1000 model && \
    gpasswd -d model root || true

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y --no-install-recommends ca-certificates && apt-get clean

# First install software-properties-common to get add-apt-repository
RUN apt-get update && apt-get install -y software-properties-common curl sudo

# Now add the PPAs
RUN add-apt-repository ppa:deadsnakes/ppa
RUN add-apt-repository ppa:mozillateam/ppa

RUN apt-get update && apt-get install -y \
    curl \
    && add-apt-repository ppa:deadsnakes/ppa \
    && apt-get update \
    && apt-get install -y \
    python3.12 \
    python3.12-venv \
    python3.12-dev \
    python3-pip \
    python3-tk \
    python3-pil \
    gnome-screenshot \
    wget \
    git \
    #############################################################
    ## UI packages for computer use
    #############################################################
    xvfb \
    xterm \
    ## `xdotool` used for automating UI interactions (e.g., typing)
    xdotool \
    ## `scrot` used for taking screenshots
    scrot \
    ## `imagemagick` required for taking screenshots
    imagemagick \
    sudo \
    mutter \
    ## VNC installed to make debugging easier, you can view the UI of the docker container from your laptop
    x11vnc \
    ## Tint2 provides a taskbar, you can add applications to the task bar to make them accessible for the model, look at `.config/tint2` for configuration
    tint2 \
    #############################################################
    ## Networking packages for VNC
    #############################################################
    net-tools \
    netcat \
    ##############################################################
    ## Firefox packages for computer use
    ##############################################################
    # In Ubuntu 22.04, the `firefox` package is just a placeholder for a snap package, and we can't use snap in Docker (snap needs systemd)
    # We add in the Mozilla ppa so we can install an extended support release version of firefox, which does not use snap
    firefox-esr \
    && apt-get clean

RUN update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.12 1 \
    && update-alternatives --set python3 /usr/bin/python3.12 \
    && ln -s /usr/bin/python3 /usr/bin/python

# Bootstrap pip for Python 3.12 (distutils was removed in 3.12, so system pip doesn't work)
RUN python -m ensurepip --upgrade
RUN python -m pip install --upgrade pip
RUN python -m pip install uv

RUN uv pip install --system pyautogui
RUN touch /home/model/.Xauthority

WORKDIR /mcp_server
RUN chmod -R 0700 /mcp_server
RUN mkdir /tests && chmod -R 0700 /tests
RUN mkdir /test && chmod -R 0700 /test
RUN mkdir /grade && chmod -R 0700 /grade

RUN mkdir -p apex_arena
COPY . apex_arena
COPY pyproject.toml .

RUN uv pip install --system -e .

RUN uv pip install --system pytest
ENV WORKDIR=/workdir
ENV SCREENSHOT_DIR=${WORKDIR}/screenshots

RUN mkdir -p ${WORKDIR}
RUN mkdir -p ${SCREENSHOT_DIR}

RUN chown -R model:model ${WORKDIR}
RUN chown -R model:model ${SCREENSHOT_DIR}
RUN mkdir -p ${WORKDIR}/bin

RUN curl -L https://github.com/mozilla/geckodriver/releases/download/v0.36.0/geckodriver-v0.36.0-linux64.tar.gz -o geckodriver.tar.gz && \
    tar -xvf geckodriver.tar.gz && \
    rm geckodriver.tar.gz && \
    mv geckodriver ${WORKDIR}/bin/

RUN git clone --branch v1.5.0 https://github.com/novnc/noVNC.git ${WORKDIR}/noVNC && \
    git clone --branch v0.12.0 https://github.com/novnc/websockify ${WORKDIR}/noVNC/utils/websockify && \
    ln -s ${WORKDIR}/noVNC/vnc.html ${WORKDIR}/noVNC/index.html

ARG DISPLAY_NUM=1
ARG COMPUTER_HEIGHT_PX=768
ARG COMPUTER_WIDTH_PX=1024

ENV DISPLAY_NUM=$DISPLAY_NUM
ENV COMPUTER_HEIGHT_PX=$COMPUTER_HEIGHT_PX
ENV COMPUTER_WIDTH_PX=$COMPUTER_WIDTH_PX

########################################################################
## Some helpful environment variables
########################################################################
ENV FIREFOX_PATH=/usr/bin/firefox-esr
ENV GECKODRIVER_PATH=${WORKDIR}/bin/geckodriver

# Set root password - model user can only access root via su with this password
RUN echo 'root:mypassword' | chpasswd

# Ensure model user is NOT in sudoers (remove any existing sudo access)
RUN sed -i '/^model/d' /etc/sudoers 2>/dev/null || true


WORKDIR ${WORKDIR}
