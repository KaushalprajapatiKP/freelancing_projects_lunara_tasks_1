FROM docker.io/ubuntu:22.04

RUN groupadd -g 1000 model && \
    useradd -m -u 1000 -g 1000 model && \
    gpasswd -d model root || true

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y --no-install-recommends ca-certificates && apt-get clean

RUN apt-get update && apt-get install -y software-properties-common curl sudo

RUN add-apt-repository ppa:deadsnakes/ppa

RUN apt-get update && apt-get install -y \
    curl \
    && add-apt-repository ppa:deadsnakes/ppa \
    && apt-get update \
    && apt-get install -y \
    python3.12 \
    python3.12-venv \
    python3.12-dev \
    python3-pip \
    wget \
    && apt-get clean

RUN update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.12 1 \
    && update-alternatives --set python3 /usr/bin/python3.12 \
    && ln -s /usr/bin/python3 /usr/bin/python

# Bootstrap pip for Python 3.12 (distutils was removed in 3.12, so system pip doesn't work)
RUN python -m ensurepip --upgrade
RUN python -m pip install --upgrade pip
RUN python -m pip install uv

WORKDIR /mcp_server
RUN chmod -R 0700 /mcp_server
RUN mkdir /tests && chmod -R 0700 /tests
RUN mkdir /test && chmod -R 0700 /test
RUN mkdir /grade && chmod -R 0700 /grade

RUN mkdir -p apex_arena
COPY . apex_arena
COPY pyproject.toml .

RUN uv pip install --system -e .

RUN uv pip install --system pytest
ENV WORKDIR=/workdir

RUN mkdir -p ${WORKDIR}

RUN chown -R model:model ${WORKDIR}
# Set root password - model user can only access root via su with this password
RUN echo 'root:mypassword' | chpasswd

# Ensure model user is NOT in sudoers (remove any existing sudo access)
RUN sed -i '/^model/d' /etc/sudoers 2>/dev/null || true

WORKDIR ${WORKDIR}
